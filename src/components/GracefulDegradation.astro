---
// Graceful Degradation Component
// Provides fallbacks for JavaScript-dependent features

export interface Props {
  feature: 'search' | 'theme-toggle' | 'copy-button' | 'newsletter' | 'custom';
  fallbackText?: string;
  showFallback?: boolean;
}

const { 
  feature, 
  fallbackText,
  showFallback = true 
} = Astro.props;

// Default fallback messages for different features
const defaultFallbacks = {
  search: '‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ JavaScript ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô JavaScript ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏ó‡∏ô',
  'theme-toggle': '‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô theme ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ JavaScript ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏ó‡∏ô',
  'copy-button': '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ JavaScript ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á',
  newsletter: '‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Newsletter ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ JavaScript ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà hello@techgloss.dev ‡πÅ‡∏ó‡∏ô',
  custom: fallbackText || '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ JavaScript'
};

const message = fallbackText || defaultFallbacks[feature];
---

<!-- Main content (requires JavaScript) -->
<div class="js-required" data-feature={feature}>
  <slot />
</div>

<!-- Fallback content (shown when JavaScript is disabled) -->
{showFallback && (
  <noscript>
    <div class="no-js-fallback bg-yellow-50 border border-yellow-200 rounded-lg p-4 my-4">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <span class="text-yellow-600 text-xl">‚ö†Ô∏è</span>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">
            JavaScript ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          </h3>
          <p class="text-sm text-yellow-700 mt-1">
            {message}
          </p>
          
          {feature === 'search' && (
            <div class="mt-3">
              <p class="text-sm text-yellow-700 mb-2">‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô:</p>
              <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                <li>‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</li>
                <li>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
                <li>‡πÉ‡∏ä‡πâ Ctrl+F ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤</li>
              </ul>
            </div>
          )}
          
          {feature === 'theme-toggle' && (
            <div class="mt-3">
              <p class="text-sm text-yellow-700">
                üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Dark Mode ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£
              </p>
            </div>
          )}
          
          {feature === 'newsletter' && (
            <div class="mt-3">
              <a 
                href="mailto:hello@techgloss.dev?subject=Newsletter Subscription&body=‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö Newsletter ‡∏à‡∏≤‡∏Å TechGloss"
                class="inline-flex items-center text-sm bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded transition-colors"
              >
                üìß ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏°‡∏±‡∏Ñ‡∏£
              </a>
            </div>
          )}
        </div>
      </div>
    </div>
  </noscript>
)}

<!-- Enhanced fallback for critical features -->
{feature === 'search' && (
  <div class="js-fallback-search hidden">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 my-4">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <span class="text-blue-600 text-xl">üîç</span>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-blue-800">
            ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          </h3>
          <p class="text-sm text-blue-700 mt-1">
            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
          </p>
          <div class="mt-3 flex gap-2">
            <button 
              onclick="window.location.reload()"
              class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded transition-colors"
            >
              ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
            </button>
            <button 
              onclick="showBrowserSearch()"
              class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1 rounded transition-colors"
            >
              ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
)}

<script define:vars={{ feature }}>
  // Graceful degradation functionality
  function setupGracefulDegradation() {
    const jsRequired = document.querySelector(`[data-feature="${feature}"]`);
    
    if (!jsRequired) return;
    
    // Test if the feature is working
    let isWorking = true;
    
    try {
      // Feature-specific tests
      switch (feature) {
        case 'search':
          // Test if search functionality is available
          if (typeof window.Fuse === 'undefined' && !document.querySelector('[data-search-input]')) {
            isWorking = false;
          }
          break;
          
        case 'theme-toggle':
          // Test if theme toggle is working
          if (!localStorage || typeof localStorage.getItem !== 'function') {
            isWorking = false;
          }
          break;
          
        case 'copy-button':
          // Test if clipboard API is available
          if (!navigator.clipboard && !document.execCommand) {
            isWorking = false;
          }
          break;
          
        case 'newsletter':
          // Test if fetch API is available
          if (typeof fetch === 'undefined') {
            isWorking = false;
          }
          break;
      }
    } catch (error) {
      isWorking = false;
      console.warn(`Feature ${feature} is not working:`, error);
    }
    
    // Show fallback if feature is not working
    if (!isWorking) {
      const fallback = document.querySelector(`.js-fallback-${feature}`);
      if (fallback) {
        fallback.classList.remove('hidden');
      }
    }
  }
  
  // Browser search functionality
  window.showBrowserSearch = function() {
    const searchTerm = prompt('‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:');
    if (searchTerm) {
      // Use browser's find functionality
      if (window.find) {
        window.find(searchTerm);
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Ctrl+F (‡∏´‡∏£‡∏∑‡∏≠ Cmd+F ‡∏ö‡∏ô Mac) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + searchTerm);
      }
    }
  };
  
  // Initialize when DOM is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupGracefulDegradation);
  } else {
    setupGracefulDegradation();
  }
  
  // Monitor for JavaScript errors related to this feature
  window.addEventListener('error', (event) => {
    if (event.message && event.message.includes(feature)) {
      setupGracefulDegradation();
    }
  });
</script>

<style>
  /* Ensure fallback content is properly styled */
  .no-js-fallback {
    /* Styles for no-JavaScript fallback */
  }
  
  .js-fallback-search {
    /* Styles for search fallback */
  }
  
  /* Hide JavaScript-required content when JS is disabled */
  .no-js .js-required {
    display: none;
  }
  
  /* Show fallback content when JS is disabled */
  .no-js .no-js-fallback {
    display: block !important;
  }
</style>